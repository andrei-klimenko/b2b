## Deployment process

Деплой приложения внутри kubernetes происходит по blue-green стратегии, при которой старая версия приложения будет удалена, если система удостоверится, что новая версия доступна и функционирует. Для этого необходимо - определения правильной 'readinessProbe' , который выступает в качестве healthcheck для приложения. И в случае, если `readinessProbe` отвечает без ошибки kuberntes через kube-proxy -> kube-service начнет посылать запросы на новою версию приложения.

При этом стоит увеличить количество реплик для большей доступности приложения и исключения какого либо downtime.

'readinessProbe' и `replicaCount`  обычно определены в deployment.yaml, который конфигурируется через пакетный менеджер helm , который позволяет гибко конфигурировать ресурсы, которые должны быть развернуты и helm chart может быть развернут множеством способам.

Учитывая то, что у нас есть рабочий kubernetes cluster внутри aws и нужно развернуть приложение внутри контура, возможные решения для деплоя приложение с нужной версией:
  - gitlab-ci + helm (что дает гибкость для деплоя и контроль со стороны команды разработчиков)
  - flux cd ( GitOps инструмент для автоматического обновления приложений внутри kubernetes )


## Helm chart
Оба варианта развертывают приложение из [helm chart app_v1](app_v1/), который был сгенерирован
    
	helm create app_v1

Изменений которые были совершены внутри chart:

Для `livenessProbe` `readinessProbe` и  `image` - были добавлены шаблоны tpl, которые пробрасываются из values.yaml

## Gitlab-ci + helm

Реализация состоит из gitlab-ci.yml файла, который отвечает за весь процесс CI/CD для приложения app:v1.17b.

Внутри файла содержится 4 достаточные этапа, через которые проходит образ при разработке.

* __Lint__

* __Build__ через обычный docker in docker

* __Test__

* __Deploy__ приложение проходит через helm при этом файл с values добавляется/перезаписывает значения из директории `env/{env-name}.yaml`.
Деплой происходит только при указании тега внутри репозитория. Regexp подходит указанному значению

## Flux cd

** Подразумевается что [Flux cd](https://fluxcd.io/flux/get-started/#add-podinfo-repository-to-flux) уже развернут внутри кластера и отслеживает состояние .

В папке [flux base](flux/base/) представлены базовые ресурсы, которые будут развернуты внутри каждого окружения в нашем случае это `dev`
В нем определен [release.yaml](base/release.yaml) - в котором содержится ресурсы flux для определения источника кода с helm chart и [secrets.yaml](base/secrets.yaml) в котором определены секреты для репозитория с chart и docker registry.

В папке [flux dev](flux/dev/) представлены custom resources для отслеживания новых образов с нужным тегом внутри docker registry, которые будут изменять образ внутри файла [patch.yaml](flux/dev/patch.yaml) в котором определены values для нашего app_v1 chart.  

